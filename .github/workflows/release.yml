name: Publish Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true
      after-version:
        description: 'Snapshot version after release'
        required: true

jobs:
  set-release-version:
    uses: SkinsRestorer/SkinsRestorer/.github/workflows/set-version.yml@dev
    with:
      version: ${{ inputs.version }}
    secrets: inherit

  build:
    needs: set-release-version
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        ref: ${{ github.ref }}
    - name: Set up Gradle
      uses: gradle/actions/setup-gradle@v4
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
    - name: Build with Gradle
      run: ./gradlew build test --stacktrace --scan

    - name: Build Changelog
      id: github_release
      uses: mikepenz/release-changelog-builder-action@v5
      with:
        mode: COMMIT
        toTag: ${{ github.ref }}
        configurationJson: |
          {
            "template": "#{{CHANGELOG}}",
            "commit_template": "- [`#{{SHORT_MERGE_SHA}}`](https://github.com/SkinsRestorer/SkinsRestorer/commit/#{{MERGE_SHA}}) #{{TITLE}}",
            "categories": [
              {
                  "title": "## ðŸš€ Features",
                  "labels": ["feat", "feature"]
              },
              {
                  "title": "## ðŸ› Fixes",
                  "labels": ["fix", "bug"]
              },
              {
                  "title": "## ðŸŽï¸ Performance",
                  "labels": ["perf"]
              },
              {
                  "title": "## ðŸ— Refactor",
                  "labels": ["refactor"]
              },
              {
                  "title": "## ðŸ“ Documentation",
                  "labels": ["docs"]
              },
              {
                  "title": "## ðŸ”¨ Build",
                  "labels": ["build", "chore", "ci"]
              },
              {
                  "title": "## ðŸ’… Style",
                  "labels": ["style"]
              },
              {
                  "title": "## ðŸ§ª Tests",
                  "labels": ["test"]
              },
              {
                  "title": "## ðŸ’¬ Other",
                  "labels": []
              },
              {
                "title": "## ðŸ“¦ Dependencies",
                "labels": ["dependencies"]
              }
            ],
            "empty_template": "no changes",
            "label_extractor": [
              {
                "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test){1}(\\([\\w\\-\\.]+\\))?(!)?: ([\\w ])+([\\s\\S]*)",
                "on_property": "title",
                "target": "$1"
              }
            ],
            "custom_placeholders": [
              {
                "name": "SHORT_MERGE_SHA",
                "source": "MERGE_SHA",
                "transformer": {
                  "pattern": "^([0-9a-f]{7})[0-9a-f]*$",
                  "target": "$1"
                }
              }
            ]
          }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Read modMcVersion from gradle.properties
      id: modMcVersion
      run: |
        modMcVersion=$(grep '^modMcVersion=' gradle.properties | cut -d'=' -f2-)
        echo "modMcVersion=$modMcVersion" >> "$GITHUB_OUTPUT"

    - name: Release to GitHub
      uses: Kir-Antipov/mc-publish@v3.3
      with:
        github-tag: ${{ inputs.version }}
        github-generate-changelog: false
        github-draft: false
        github-prerelease: false
        github-commitish: dev
        github-token: ${{ secrets.GITHUB_TOKEN }}

        files: |
          build/libs/SkinsRestorer.jar
          mod/build/libs/SkinsRestorer-Mod-*-fabric.jar
          mod/build/libs/SkinsRestorer-Mod-*-neoforge.jar

        name: SkinsRestorer ${{ inputs.version }}
        version: ${{ inputs.version }}
        version-type: release
        changelog: |
          [![modrinth](https://cdn.jsdelivr.net/npm/@intergrav/devins-badges@3/assets/cozy/available/modrinth_vector.svg)](https://modrinth.com/plugin/skinsrestorer/version/${{ inputs.version }}) [![hangar](https://cdn.jsdelivr.net/npm/@intergrav/devins-badges@3/assets/cozy/available/hangar_vector.svg)](https://hangar.papermc.io/SRTeam/SkinsRestorer/versions/${{ inputs.version }})

          ${{ steps.github_release.outputs.changelog }}

        retry-attempts: 2
        retry-delay: 10000
        fail-mode: fail

    - name: Release plugin to Modrinth
      uses: Kir-Antipov/mc-publish@v3.3
      with:
        modrinth-id: skinsrestorer
        modrinth-featured: true
        modrinth-unfeature-mode: subset
        modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

        files: |
          build/libs/SkinsRestorer.jar

        name: SkinsRestorer ${{ inputs.version }}
        version: ${{ inputs.version }}
        version-type: release
        changelog: ${{ steps.github_release.outputs.changelog }}

        loaders: |
          bukkit
          bungeecord
          folia
          paper
          purpur
          spigot
          velocity
          waterfall
        game-versions: |
          >=1.8.0
        game-version-filter: releases
        java: |
          8
          11
          17
          21

        retry-attempts: 2
        retry-delay: 10000
        fail-mode: fail

    - name: Release Fabric mod to Modrinth
      uses: Kir-Antipov/mc-publish@v3.3
      with:
        modrinth-id: skinsrestorer
        modrinth-featured: true
        modrinth-unfeature-mode: subset
        modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

        files: |
          mod/build/libs/SkinsRestorer-Mod-*-fabric.jar

        name: SkinsRestorer ${{ inputs.version }} Fabric
        version: ${{ inputs.version }}-fabric
        version-type: release
        changelog: ${{ steps.github_release.outputs.changelog }}

        loaders: |
          fabric
        game-versions: |
          ${{ steps.modMcVersion.outputs.modMcVersion }}
        game-version-filter: releases
        java: |
          21

        retry-attempts: 2
        retry-delay: 10000
        fail-mode: fail

    - name: Release NeoForge mod to Modrinth
      uses: Kir-Antipov/mc-publish@v3.3
      with:
        modrinth-id: skinsrestorer
        modrinth-featured: true
        modrinth-unfeature-mode: subset
        modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

        files: |
          mod/build/libs/SkinsRestorer-Mod-*-neoforge.jar

        name: SkinsRestorer ${{ inputs.version }} NeoForge
        version: ${{ inputs.version }}-neoforge
        version-type: release
        changelog: ${{ steps.github_release.outputs.changelog }}

        loaders: |
          neoforge
        game-versions: |
          ${{ steps.modMcVersion.outputs.modMcVersion }}
        game-version-filter: releases
        java: |
          21

        retry-attempts: 2
        retry-delay: 10000
        fail-mode: fail

    - name: Publish to Hangar
      run: ./gradlew publishPluginPublicationToHangar --stacktrace
      env:
        HANGAR_TOKEN: ${{ secrets.HANGAR_API_TOKEN }}
        HANGAR_CHANGELOG: ${{ steps.github_release.outputs.changelog }}

    - name: Discord Webhook Action
      uses: tsickert/discord-webhook@v7.0.0
      with:
        webhook-url: ${{ secrets.WEBHOOK_URL }}
        content: <@&1201133350916739173> New SkinsRestorer version released!
        embed-title: SkinsRestorer ${{ inputs.version }}
        embed-description: SkinsRestorer ${{ inputs.version }} has been released! Changelog and download can be found at https://modrinth.com/plugin/skinsrestorer/version/${{ inputs.version }}
        embed-color: 16641028
        embed-thumbnail-url: https://skinsrestorer.net/logo.png

  deploy-javadoc:
    needs: build
    uses: SkinsRestorer/SkinsRestorer/.github/workflows/deploy-javadoc.yml@dev
    secrets: inherit

  set-after-version:
    needs: deploy-javadoc
    uses: SkinsRestorer/SkinsRestorer/.github/workflows/set-version.yml@dev
    with:
      version: ${{ inputs.after-version }}
    secrets: inherit
